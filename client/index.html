<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Impostor Arcane ‚Äì Mesa Online</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050816;
      --card: #0b1020;
      --card-soft: #111827;
      --accent: #f97316;
      --accent-strong: #fb3b78;
      --text: #f9fafb;
      --muted: #9ca3af;
      --danger: #f97373;
      --success: #22c55e;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }
    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: stretch;
    }
    .app {
      width: 100%;
      max-width: 1200px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: relative;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .title-block {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--success);
      box-shadow: 0 0 10px rgba(34,197,94,0.9);
    }
    .title {
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: .18em;
      text-transform: uppercase;
    }
    .subtitle {
      font-size: .8rem;
      color: var(--muted);
    }
    main {
      display: grid;
      grid-template-columns: minmax(0,2.1fr) minmax(0,1.2fr);
      gap: 16px;
    }
    @media (max-width: 880px) {
      main { grid-template-columns: 1fr; }
    }
    .card {
      background: radial-gradient(circle at top, #0b1120, #020617);
      border-radius: 20px;
      padding: 14px;
      border: 1px solid rgba(148,163,184,0.25);
      box-shadow: 0 22px 60px rgba(15,23,42,0.9);
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 0 0, rgba(249,115,22,0.16), transparent 55%),
        radial-gradient(circle at 100% 0, rgba(59,130,246,0.18), transparent 55%);
      opacity: .6;
      pointer-events: none;
    }
    .card-inner {
      position: relative;
      z-index: 1;
    }

    /* Mesa con imagen */
    .mesa-wrapper {
      border-radius: 20px;
      overflow: hidden;
      background: #020617;
      border: 1px solid rgba(148,163,184,0.35);
      position: relative;
      min-height: 320px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .mesa-img {
      width: 100%;
      max-width: 720px;
      display: block;
    }
    .mesa-overlay-card {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-40%);
      background: radial-gradient(circle at 0 0, #f97316, #9f1239);
      padding: 10px 16px;
      border-radius: 16px;
      box-shadow:
        0 14px 36px rgba(15,23,42,0.95),
        0 0 0 1px rgba(15,23,42,0.9),
        0 0 18px rgba(248,250,252,0.45);
      text-align: center;
      text-transform: uppercase;
      letter-spacing: .16em;
      font-size: .65rem;
      color: #0f172a;
    }
    .mesa-word {
      margin-top: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(248,250,252,0.9);
      color: #0f172a;
      font-size: .85rem;
      letter-spacing: .12em;
    }
    .mesa-role {
      margin-top: 4px;
      font-size: .65rem;
      letter-spacing: .12em;
      color: rgba(15,23,42,0.8);
    }

    .hud {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      font-size: .8rem;
    }
    .chip {
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      font-size: .7rem;
      text-transform: uppercase;
      letter-spacing: .16em;
      color: var(--muted);
    }
    .timer {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.85);
      border: 1px solid rgba(148,163,184,0.35);
    }
    .timer-label {
      font-size: .7rem;
      text-transform: uppercase;
      letter-spacing: .16em;
      color: var(--muted);
    }
    .timer-value {
      font-variant-numeric: tabular-nums;
      font-weight: 600;
    }
    .phase-pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.9);
      font-size: .7rem;
      text-transform: uppercase;
      letter-spacing: .18em;
      color: var(--muted);
    }
    .phase-pill.vote {
      border-color: rgba(248,113,113,0.8);
      background: rgba(127,29,29,0.9);
      color: #fecaca;
    }

    .controls {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: .8rem;
      cursor: pointer;
      background: rgba(15,23,42,0.98);
      color: var(--text);
      border: 1px solid rgba(148,163,184,0.45);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all .16s ease;
    }
    button.primary {
      background: radial-gradient(circle at 0 0, #22c55e, #16a34a);
      color: #022c22;
      border-color: rgba(74,222,128,0.9);
      box-shadow: 0 0 18px rgba(22,163,74,0.75);
      font-weight: 600;
    }
    button.danger {
      background: radial-gradient(circle at 0 0, #fb7185, #b91c1c);
      border-color: rgba(248,113,113,0.9);
    }
    button:disabled {
      opacity: .35;
      cursor: default;
      box-shadow: none;
    }
    button:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(15,23,42,0.9);
    }

    .voice-panel {
      margin-top: 8px;
      padding: 8px;
      border-radius: 14px;
      background: rgba(15,23,42,0.95);
      border: 1px dashed rgba(148,163,184,0.45);
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: .8rem;
    }
    .voice-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }
    .voice-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: .78rem;
      color: var(--muted);
    }
    .voice-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #6b7280;
    }
    .voice-dot.active {
      background: var(--success);
      box-shadow: 0 0 10px rgba(34,197,94,0.9);
    }
    .voice-level {
      flex: 1;
      height: 6px;
      border-radius: 999px;
      background: rgba(30,41,59,0.9);
      overflow: hidden;
    }
    .voice-level-inner {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg,#22c55e,#facc15,#fb923c);
      transition: width .12s linear;
    }
    .voice-tip {
      font-size: .72rem;
      color: var(--muted);
    }

    /* Sidebar */
    .sidebar-section {
      margin-bottom: 14px;
    }
    .sidebar-section h3 {
      font-size: .75rem;
      text-transform: uppercase;
      letter-spacing: .2em;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .players-list {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(140px,1fr));
      gap: 6px;
      font-size: .8rem;
    }
    .player-item {
      padding: 6px 8px;
      border-radius: 12px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.4);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }
    .player-item-main {
      display: flex;
      flex-direction: column;
    }
    .player-name {
      font-weight: 500;
    }
    .player-sub {
      font-size: .65rem;
      text-transform: uppercase;
      letter-spacing: .16em;
      color: var(--muted);
    }
    .log {
      max-height: 170px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .log-line {
      font-size: .78rem;
      color: var(--muted);
      margin-bottom: 3px;
      display: flex;
      gap: 6px;
      align-items: baseline;
    }
    .log-tag {
      font-size: .65rem;
      text-transform: uppercase;
      letter-spacing: .18em;
      color: rgba(148,163,184,0.9);
    }

    /* Lobby */
    .lobby-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      backdrop-filter: blur(4px);
    }
    .lobby-panel {
      width: 100%;
      max-width: 540px;
      border-radius: 22px;
      padding: 18px;
      background: radial-gradient(circle at top, #020617, #020617 45%, #000 100%);
      border: 1px solid rgba(148,163,184,0.45);
      box-shadow: 0 24px 80px rgba(15,23,42,0.95);
    }
    .lobby-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .lobby-title {
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: .18em;
    }
    .lobby-tabs {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      overflow: hidden;
    }
    .lobby-tab {
      padding: 5px 10px;
      font-size: .75rem;
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: .16em;
      border-right: 1px solid rgba(148,163,184,0.35);
    }
    .lobby-tab:last-child {
      border-right: none;
    }
    .lobby-tab.active {
      background: rgba(34,197,94,0.16);
      color: #bbf7d0;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
      margin-bottom: 8px;
      font-size: .8rem;
    }
    .field label {
      font-size: .72rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .14em;
    }
    .field input,
    .field select {
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.95);
      color: var(--text);
      font-size: .8rem;
    }
    .lobby-grid {
      display: grid;
      grid-template-columns: repeat(2,minmax(0,1fr));
      gap: 10px;
      margin-bottom: 8px;
    }
    .lobby-footer {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      font-size: .75rem;
      color: var(--muted);
    }
    .room-code {
      font-variant-numeric: tabular-nums;
      letter-spacing: .16em;
    }
    .my-player {
      font-size: .75rem;
      color: var(--muted);
      margin-top: 4px;
    }
    .my-player select {
      margin-left: 6px;
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.95);
      color: var(--text);
      font-size: .75rem;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <div class="title-block">
          <div class="status-dot"></div>
          <div>
            <div class="title">IMPOSTOR ARCANE</div>
            <div class="subtitle" id="subtitle">
              Configur√° jugadores y cre√° la sala para empezar la partida.
            </div>
          </div>
        </div>
      </div>
      <div class="my-player" id="myPlayerBox">
        Este dispositivo juega como:
        <span id="myPlayerName">sin asignar</span>
      </div>
    </header>

    <!-- Lobby -->
    <div class="lobby-overlay" id="lobby">
      <div class="lobby-panel">
        <div class="lobby-header">
          <div class="lobby-title">Configurar partida</div>
          <div class="lobby-tabs">
            <button class="lobby-tab active" id="tabCreate">Crear sala</button>
            <button class="lobby-tab" id="tabJoin">Unirse</button>
          </div>
        </div>

        <div id="panelCreate">
          <div class="lobby-grid">
            <div class="field">
              <label for="hostName">Tu nombre</label>
              <input id="hostName" type="text" placeholder="Meli" />
            </div>
            <div class="field">
              <label for="maxPlayers">Jugadores</label>
              <input id="maxPlayers" type="number" min="3" max="15" value="10" />
            </div>
          </div>
          <div class="field">
            <label for="impostors">Impostores</label>
            <input id="impostors" type="number" min="1" max="4" value="3" />
          </div>
          <div class="controls" style="justify-content:flex-end; margin-top:4px;">
            <button id="btnCreate" class="primary">Crear sala</button>
          </div>
          <div class="lobby-footer">
            <div>
              Esta versi√≥n funciona como demo en <strong>un solo dispositivo</strong>.
              M√°s adelante se conecta online para que cada uno entre desde su celu.
            </div>
            <div class="room-code" id="roomCode">ARC-000</div>
          </div>
        </div>

        <div id="panelJoin" style="display:none;">
          <div class="lobby-grid">
            <div class="field">
              <label for="joinName">Tu nombre</label>
              <input id="joinName" type="text" placeholder="Invitado" />
            </div>
            <div class="field">
              <label for="joinCode">C√≥digo de sala</label>
              <input id="joinCode" type="text" placeholder="ARC-123" />
            </div>
          </div>
          <div class="controls" style="justify-content:flex-end;">
            <button id="btnJoin" class="primary">Unirse</button>
          </div>
          <div class="lobby-footer">
            <div>
              En la versi√≥n online real, cada jugador entrar√≠a con su c√≥digo.
              Por ahora, todo se simula en esta misma pantalla.
            </div>
          </div>
        </div>
      </div>
    </div>

    <main>
      <section class="card">
        <div class="card-inner">
          <div class="mesa-wrapper">
            <img src="mesa-impostor.png" alt="Mesa de impostores" class="mesa-img" />
            <div class="mesa-overlay-card">
              CARTA
              <div class="mesa-word" id="wordDisplay">----</div>
              <div class="mesa-role" id="roleDisplay">
                Eleg√≠ tu nombre para ver tu carta.
              </div>
            </div>
          </div>

          <div class="hud">
            <div class="timer">
              <span class="timer-label">Turno</span>
              <span class="timer-value" id="turnTimer">00:10</span>
            </div>
            <div class="timer">
              <span class="timer-label">Votaci√≥n</span>
              <span class="timer-value" id="voteTimer">03:00</span>
            </div>
            <div class="phase-pill" id="phasePill">Fase: Esperando</div>
            <div class="chip" id="chipConfig">Sala sin configurar</div>
          </div>

          <div class="controls">
            <button id="btnStart" class="primary" disabled>‚ñ∂ Iniciar ronda</button>
            <button id="btnSkipVote" disabled>‚è≠ Nadie / Saltar voto</button>
          </div>

          <div class="voice-panel">
            <div class="voice-row">
              <div class="voice-status">
                <div class="voice-dot" id="voiceDot"></div>
                <span id="voiceStatus">Micr√≥fono en silencio</span>
              </div>
              <button id="btnMic">üéôÔ∏è Decir palabra</button>
            </div>
            <div class="voice-row">
              <div class="voice-level">
                <div class="voice-level-inner" id="voiceLevel"></div>
              </div>
              <span id="voiceHint" style="font-size:.72rem; color:var(--muted);">
                Activ√° el micr√≥fono s√≥lo cuando sea tu turno.
              </span>
            </div>
            <div class="voice-tip">
              Cada jugador tiene <strong>10 s</strong> para decir una palabra.
              Despu√©s de que hablen todos, se abre votaci√≥n por <strong>3 minutos</strong>.
            </div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-inner">
          <div class="sidebar-section">
            <h3>Mesa y jugadores</h3>
            <div class="players-list" id="playersList"></div>
          </div>
          <div class="sidebar-section">
            <h3>Registro de la ronda</h3>
            <div class="log" id="log"></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ---- Estado b√°sico (demo local, un solo dispositivo) ----
    const subtitle = document.getElementById('subtitle');
    const lobby = document.getElementById('lobby');
    const tabCreate = document.getElementById('tabCreate');
    const tabJoin = document.getElementById('tabJoin');
    const panelCreate = document.getElementById('panelCreate');
    const panelJoin = document.getElementById('panelJoin');
    const hostNameInput = document.getElementById('hostName');
    const maxPlayersInput = document.getElementById('maxPlayers');
    const impostorsInput = document.getElementById('impostors');
    const roomCodeEl = document.getElementById('roomCode');
    const btnCreate = document.getElementById('btnCreate');
    const joinNameInput = document.getElementById('joinName');
    const joinCodeInput = document.getElementById('joinCode');
    const btnJoin = document.getElementById('btnJoin');

    const myPlayerBox = document.getElementById('myPlayerBox');
    const myPlayerNameEl = document.getElementById('myPlayerName');

    const wordDisplay = document.getElementById('wordDisplay');
    const roleDisplay = document.getElementById('roleDisplay');
    const turnTimerEl = document.getElementById('turnTimer');
    const voteTimerEl = document.getElementById('voteTimer');
    const phasePill = document.getElementById('phasePill');
    const chipConfig = document.getElementById('chipConfig');
    const playersListEl = document.getElementById('playersList');
    const logEl = document.getElementById('log');
    const btnStart = document.getElementById('btnStart');
    const btnSkipVote = document.getElementById('btnSkipVote');

    const btnMic = document.getElementById('btnMic');
    const voiceDot = document.getElementById('voiceDot');
    const voiceStatus = document.getElementById('voiceStatus');
    const voiceLevel = document.getElementById('voiceLevel');
    const voiceHint = document.getElementById('voiceHint');

    let roomCode = '';
    let maxPlayers = 0;
    let impostors = 0;
    let players = []; // {id,name,impostor,hasSpoken,votes}
    let myId = null;
    let currentTurn = 0;
    let phase = 'esperando';
    let turnSeconds = 10;
    let voteSeconds = 180;
    let turnInterval = null;
    let voteInterval = null;
    let localVotesDone = 0;
    let localHasVoted = false;

    const WORDS = [
      'GALAXIA','MISTERIO','AVENTURA','DESIERTO','OC√âANO','LABERINTO','TRAVES√çA',
      'MONTA√ëA','ISLA','INVESTIGACI√ìN','SECRETO','FESTIVAL','HOSPITAL','CIUDAD',
      'MUSEO','TORMENTA','PUEBLO','TEATRO','MERCADO','PLANETA','CIRCO','CASTILLO',
      'RECUERDO','NOCHE','VERANO','INVIERNO','CARRERA','MISI√ìN','EXPEDICI√ìN'
    ];
    let secretWord = '---';

    function log(tag, text) {
      const line = document.createElement('div');
      line.className = 'log-line';
      const t = document.createElement('span');
      t.className = 'log-tag';
      t.textContent = tag;
      const msg = document.createElement('span');
      msg.textContent = text;
      line.appendChild(t);
      line.appendChild(msg);
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function randomRoomCode() {
      const chars = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789';
      let code = '';
      for (let i = 0; i < 3; i++) {
        code += chars[Math.floor(Math.random() * chars.length)];
      }
      return 'ARC-' + code;
    }

    function assignRoles() {
      const indices = [...Array(players.length).keys()];
      // elegir impostores
      let remaining = impostors;
      while (remaining > 0 && indices.length) {
        const idx = Math.floor(Math.random() * indices.length);
        const pIndex = indices.splice(idx,1)[0];
        players[pIndex].impostor = true;
        remaining--;
      }
      // palabra clave
      secretWord = WORDS[Math.floor(Math.random() * WORDS.length)];
    }

    function updateMyCard() {
      if (myId == null) {
        wordDisplay.textContent = '----';
        roleDisplay.textContent = 'Eleg√≠ tu nombre para ver tu carta.';
        return;
      }
      const me = players.find(p => p.id === myId);
      if (!me) return;
      if (me.impostor) {
        wordDisplay.textContent = 'IMPOSTOR';
        roleDisplay.textContent = 'No reveles tu rol. Mezclate con el resto.';
      } else {
        wordDisplay.textContent = secretWord;
        roleDisplay.textContent = 'Dec√≠ algo relacionado sin decir la palabra exacta.';
      }
    }

    function renderPlayers() {
      playersListEl.innerHTML = '';
      players.forEach((p, index) => {
        const item = document.createElement('div');
        item.className = 'player-item';
        const main = document.createElement('div');
        main.className = 'player-item-main';
        const nameEl = document.createElement('span');
        nameEl.className = 'player-name';
        nameEl.textContent = p.name;
        const sub = document.createElement('span');
        sub.className = 'player-sub';
        if (phase === 'votacion') {
          sub.textContent = 'Jugador en votaci√≥n';
        } else if (phase === 'palabras' && index === currentTurn) {
          sub.textContent = 'Hablando‚Ä¶';
        } else if (phase === 'palabras' && p.hasSpoken) {
          sub.textContent = 'Ya habl√≥';
        } else {
          sub.textContent = 'Esperando turno';
        }
        main.appendChild(nameEl);
        main.appendChild(sub);

        const right = document.createElement('div');
        const btnVote = document.createElement('button');
        btnVote.textContent = 'Votar';
        btnVote.disabled = !(phase === 'votacion') || localHasVoted;
        btnVote.addEventListener('click', () => {
          if (phase !== 'votacion' || localHasVoted) return;
          p.votes++;
          localHasVoted = true;
          localVotesDone++;
          renderPlayers();
          log('VOTO', 'Votaste a ' + p.name + '.');
          if (localVotesDone >= players.length) {
            endVoting('Todos votaron');
          }
        });
        right.appendChild(btnVote);

        item.appendChild(main);
        item.appendChild(right);
        playersListEl.appendChild(item);
      });
    }

    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
    }

    function setPhase(newPhase) {
      phase = newPhase;
      if (phase === 'palabras') {
        phasePill.classList.remove('vote');
        phasePill.textContent = 'Fase: Palabras';
      } else if (phase === 'votacion') {
        phasePill.classList.add('vote');
        phasePill.textContent = 'Fase: Votaci√≥n';
      } else {
        phasePill.classList.remove('vote');
        phasePill.textContent = 'Fase: Esperando';
      }
      renderPlayers();
    }

    function startTurnTimer() {
      clearInterval(turnInterval);
      turnSeconds = 10;
      turnTimerEl.textContent = formatTime(turnSeconds);
      setPhase('palabras');
      renderPlayers();
      turnInterval = setInterval(() => {
        turnSeconds--;
        turnTimerEl.textContent = formatTime(turnSeconds);
        if (turnSeconds <= 0) {
          clearInterval(turnInterval);
          endTurn('Tiempo agotado');
        }
      }, 1000);
    }

    function endTurn(reason) {
      const p = players[currentTurn];
      if (p) {
        p.hasSpoken = true;
        log('RONDA', p.name + ' termin√≥ su turno. (' + reason + ')');
      }
      const remaining = players.findIndex(pl => !pl.hasSpoken);
      if (remaining === -1) {
        startVoting();
      } else {
        currentTurn = remaining;
        startTurnTimer();
        log('RONDA', 'Turno de ' + players[currentTurn].name + '.');
      }
      renderPlayers();
    }

    function startVoting() {
      clearInterval(turnInterval);
      setPhase('votacion');
      btnSkipVote.disabled = false;
      btnStart.disabled = true;
      voteSeconds = 180;
      voteTimerEl.textContent = formatTime(voteSeconds);
      localVotesDone = 0;
      localHasVoted = false;
      renderPlayers();
      log('VOTO', 'Comienza la votaci√≥n (3 minutos).');
      voteInterval = setInterval(() => {
        voteSeconds--;
        voteTimerEl.textContent = formatTime(voteSeconds);
        if (voteSeconds <= 0) {
          clearInterval(voteInterval);
          endVoting('Tiempo agotado');
        }
      }, 1000);
    }

    function endVoting(reason) {
      clearInterval(voteInterval);
      btnSkipVote.disabled = true;
      btnStart.disabled = false;
      setPhase('esperando');
      voteTimerEl.textContent = '03:00';

      let kicked = null;
      let maxVotes = 0;
      players.forEach(p => {
        if (p.votes > maxVotes) {
          maxVotes = p.votes;
          kicked = p;
        }
      });
      if (!kicked || maxVotes === 0) {
        log('VOTO', 'Nadie fue expulsado. (' + reason + ')');
      } else {
        log('VOTO',
          kicked.name + ' fue expulsado con ' + maxVotes +
          ' votos. ' + (kicked.impostor ? '¬°Era impostor!' : 'Era ciudadano.')
        );
      }
      players.forEach(p => { p.hasSpoken = false; p.votes = 0; });
      currentTurn = 0;
      renderPlayers();
    }

    // ----- Lobby l√≥gica (demo) -----
    tabCreate.addEventListener('click', () => {
      tabCreate.classList.add('active');
      tabJoin.classList.remove('active');
      panelCreate.style.display = '';
      panelJoin.style.display = 'none';
    });
    tabJoin.addEventListener('click', () => {
      tabJoin.classList.add('active');
      tabCreate.classList.remove('active');
      panelCreate.style.display = 'none';
      panelJoin.style.display = '';
    });

    btnCreate.addEventListener('click', () => {
      const name = (hostNameInput.value || '').trim() || 'Host';
      const mp = Math.max(3, Math.min(15, parseInt(maxPlayersInput.value || '10', 10)));
      let imp = Math.max(1, Math.min(4, parseInt(impostorsInput.value || '3', 10)));
      if (imp >= mp) imp = Math.max(1, mp-1);
      maxPlayersInput.value = mp;
      impostorsInput.value = imp;

      roomCode = randomRoomCode();
      roomCodeEl.textContent = roomCode;
      maxPlayers = mp;
      impostors = imp;

      players = [];
      const hostPlayer = {
        id: Date.now(),
        name,
        impostor: false,
        hasSpoken: false,
        votes: 0
      };
      players.push(hostPlayer);
      myId = hostPlayer.id;
      myPlayerNameEl.textContent = name;
      subtitle.textContent = mp + ' jugadores m√°x ¬∑ ' + imp +
        ' impostores ¬∑ Ronda de palabra + votaci√≥n';
      chipConfig.textContent = mp + ' jugadores m√°x ¬∑ ' + imp +
        ' impostores ¬∑ Micr√≥fono obligatorio';
      lobby.style.display = 'none';
      assignRoles();
      updateMyCard();
      renderPlayers();
      btnStart.disabled = false;
      log('SISTEMA', 'Sala ' + roomCode + ' creada. Este dispositivo juega como ' + name + '.');
    });

    btnJoin.addEventListener('click', () => {
      const name = (joinNameInput.value || '').trim() || 'Jugador';
      if (!roomCode) {
        alert('En esta demo la sala se crea s√≥lo en este dispositivo. M√°s adelante se conecta online.');
        return;
      }
      const code = (joinCodeInput.value || '').trim().toUpperCase();
      if (code !== roomCode) {
        alert('El c√≥digo no coincide con la sala actual de esta demo.');
        return;
      }
      if (players.length >= maxPlayers) {
        alert('La sala ya est√° completa.');
        return;
      }
      const newPlayer = {
        id: Date.now() + Math.floor(Math.random()*10000),
        name,
        impostor: false,
        hasSpoken: false,
        votes: 0
      };
      players.push(newPlayer);
      myId = newPlayer.id;
      myPlayerNameEl.textContent = name;
      lobby.style.display = 'none';
      assignRoles();
      updateMyCard();
      renderPlayers();
      log('SISTEMA', 'Nuevo jugador en la mesa: ' + name + '. (demo local)');
    });

    btnStart.addEventListener('click', () => {
      if (players.length < 3) {
        alert('Necesit√°s al menos 3 jugadores para empezar la ronda.');
        return;
      }
      players.forEach(p => { p.hasSpoken = false; p.votes = 0; });
      currentTurn = 0;
      setPhase('palabras');
      startTurnTimer();
      log('RONDA', 'Empieza la ronda. Arranca ' + players[0].name + '.');
    });

    btnSkipVote.addEventListener('click', () => {
      if (phase !== 'votacion') return;
      localVotesDone++;
      log('VOTO', 'Marcaste "Nadie / Saltar voto".');
      if (localVotesDone >= players.length) {
        endVoting('Todos votaron / Nadie');
      }
    });

    // ---- Voz / Micr√≥fono (solo en turno propio) ----
    let micOn = false;
    let audioContext = null;
    let analyser = null;
    let micStream = null;
    let levelAnimationId = null;

    function stopMic(endTurnToo) {
      if (micStream) {
        micStream.getTracks().forEach(t => t.stop());
        micStream = null;
      }
      if (audioContext) {
        audioContext.close();
        audioContext = null;
      }
      if (levelAnimationId) cancelAnimationFrame(levelAnimationId);
      levelAnimationId = null;
      voiceLevel.style.width = '0%';
      voiceDot.classList.remove('active');
      voiceStatus.textContent = 'Micr√≥fono en silencio';
      voiceHint.textContent = 'Activ√° el micr√≥fono s√≥lo cuando sea tu turno.';
      btnMic.textContent = 'üéôÔ∏è Decir palabra';
      micOn = false;
      if (endTurnToo && phase === 'palabras' && players[currentTurn] && players[currentTurn].id === myId) {
        clearInterval(turnInterval);
        endTurn('Cort√≥ el micr√≥fono');
      }
    }

    async function startMic() {
      if (!players.length || myId == null) {
        alert('Primero unite a la sala.');
        return;
      }
      const currentPlayer = players[currentTurn];
      if (!currentPlayer || currentPlayer.id !== myId) {
        alert('No es tu turno. Esper√° a que te toque.');
        return;
      }
      try {
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioContext.createMediaStreamSource(micStream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        source.connect(analyser);

        micOn = true;
        voiceDot.classList.add('active');
        voiceStatus.textContent = 'Hablando‚Ä¶';
        voiceHint.textContent = 'Cuando termines tu palabra, cort√° el micr√≥fono.';
        btnMic.textContent = '‚èπÔ∏è Cortar voz';

        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        function updateLevel() {
          if (!analyser) return;
          analyser.getByteFrequencyData(dataArray);
          let sum = 0;
          for (let i = 0; i < bufferLength; i++) sum += dataArray[i];
          const avg = sum / bufferLength;
          const pct = Math.min(100,(avg/255)*120);
          voiceLevel.style.width = pct.toFixed(0) + '%';
          levelAnimationId = requestAnimationFrame(updateLevel);
        }
        updateLevel();
      } catch (err) {
        console.error(err);
        alert('No se pudo usar el micr√≥fono. Revis√° los permisos del navegador.');
      }
    }

    btnMic.addEventListener('click', () => {
      if (micOn) {
        stopMic(true);
      } else {
        startMic();
      }
    });

    window.addEventListener('beforeunload', () => {
      stopMic(false);
    });
  </script>
</body>
</html>
