<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Impostor Arcane - Mesa Online</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #030712;
      --card: #020617;
      --accent: #f97316;
      --accent2: #22c55e;
      --danger: #f97373;
      --text: #f9fafb;
      --muted: #9ca3af;
      --border: rgba(148,163,184,0.35);
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }
    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: stretch;
    }
    .app {
      width: 100%;
      max-width: 1200px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: relative;
    }
    header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
    }
    .title-wrap {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .title-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 12px rgba(34,197,94,0.8);
    }
    .title {
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    .badge {
      font-size: .65rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      text-transform: uppercase;
      letter-spacing: .14em;
      color: var(--muted);
      background: rgba(15,23,42,0.9);
    }
    #headerSubtitle {
      font-size: .8rem;
      color: var(--muted);
    }
    main {
      display: grid;
      grid-template-columns: minmax(0,2.1fr) minmax(0,1.1fr);
      gap: 16px;
      filter: blur(0);
      transition: filter .2s ease, opacity .2s ease;
    }
    main.blurred {
      filter: blur(3px);
      opacity: 0.6;
      pointer-events: none;
    }
    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: radial-gradient(circle at top, #020617, #000);
      border-radius: 20px;
      padding: 14px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 40px rgba(15,23,42,0.9);
      position: relative;
      overflow: hidden;
    }
    .card-inner {
      position: relative;
      z-index: 1;
    }
    .card::before {
      content: "";
      position: absolute;
      inset: -60%;
      background:
        radial-gradient(circle at 20% 0, rgba(249,115,22,0.18), transparent 55%),
        radial-gradient(circle at 80% 10%, rgba(56,189,248,0.14), transparent 55%);
      opacity: .6;
      pointer-events: none;
    }

    .mesa-wrapper {
      position: relative;
      height: 330px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .mesa-img {
      max-width: 100%;
      max-height: 100%;
      display: block;
      filter: drop-shadow(0 18px 40px rgba(15,23,42,0.9));
    }
    .mesa-label {
      position: absolute;
      top: 16px;
      left: 18px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid var(--border);
      font-size: .65rem;
      text-transform: uppercase;
      letter-spacing: .16em;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .mesa-label-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(249,115,22,0.9);
    }
    .card-center {
      position: absolute;
      top: 46%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: radial-gradient(circle at 0 0, #f97316, #7f1d1d);
      border-radius: 18px;
      padding: 10px 18px;
      min-width: 130px;
      text-align: center;
      box-shadow:
        0 14px 30px rgba(15,23,42,0.95),
        0 0 0 1px rgba(15,23,42,0.9);
      color: #111827;
      text-transform: uppercase;
      letter-spacing: .14em;
      font-size: .65rem;
    }
    .card-center .word {
      display: inline-block;
      margin-top: 6px;
      padding: 3px 12px;
      border-radius: 999px;
      background: rgba(248,250,252,0.9);
      font-size: .85rem;
      letter-spacing: .1em;
    }
    .card-center small {
      display: block;
      margin-top: 4px;
      font-size: .6rem;
      color: rgba(15,23,42,0.9);
      letter-spacing: .08em;
    }

    .hud {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      font-size: .8rem;
    }
    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.9);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .pill-label {
      font-size: .68rem;
      text-transform: uppercase;
      letter-spacing: .14em;
      color: var(--muted);
    }
    .pill-value {
      font-variant-numeric: tabular-nums;
      font-weight: 600;
    }
    .phase-pill {
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.9);
      font-size: .7rem;
      text-transform: uppercase;
      letter-spacing: .16em;
      color: var(--muted);
    }
    .phase-pill.vote {
      border-color: rgba(248,113,113,0.8);
      background: rgba(127,29,29,0.9);
      color: #fecaca;
    }
    .chip {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: .65rem;
      text-transform: uppercase;
      letter-spacing: .14em;
      color: var(--muted);
    }

    .controls {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    button {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 7px 14px;
      font-size: .8rem;
      background: rgba(15,23,42,0.96);
      color: var(--text);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all .14s ease;
    }
    button.primary {
      background: radial-gradient(circle at 0 0, var(--accent2), #16a34a);
      border-color: rgba(34,197,94,0.9);
      color: #022c22;
      font-weight: 600;
      box-shadow: 0 0 16px rgba(34,197,94,0.7);
    }
    button.skip {
      border-style: dashed;
      opacity: .9;
    }
    button:disabled {
      opacity: .35;
      cursor: default;
      box-shadow: none;
    }
    button:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(15,23,42,0.9);
    }

    .voice-panel {
      margin-top: 10px;
      padding: 8px;
      border-radius: 14px;
      border: 1px dashed var(--border);
      background: rgba(15,23,42,0.96);
      font-size: .8rem;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .voice-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }
    .voice-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: .78rem;
      color: var(--muted);
    }
    .voice-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #6b7280;
    }
    .voice-dot.active {
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34,197,94,0.9);
    }
    .voice-level {
      flex: 1;
      height: 6px;
      border-radius: 999px;
      background: rgba(31,41,55,0.95);
      overflow: hidden;
    }
    .voice-level-inner {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg,#22c55e,#facc15,#fb923c);
      transition: width .1s linear;
    }
    .voice-tip {
      font-size: .7rem;
      color: var(--muted);
    }

    .sidebar-section {
      margin-bottom: 14px;
    }
    .sidebar-section h3 {
      font-size: .78rem;
      text-transform: uppercase;
      letter-spacing: .18em;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .players-list {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(130px,1fr));
      gap: 6px;
      font-size: .8rem;
    }
    .player-item {
      padding: 6px 8px;
      border-radius: 12px;
      background: rgba(15,23,42,0.96);
      border: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
    }
    .player-item.me {
      border-color: var(--accent2);
      box-shadow: 0 0 12px rgba(34,197,94,0.5);
    }
    .player-item .name {
      font-weight: 500;
    }
    .player-item .sub {
      font-size: .65rem;
      text-transform: uppercase;
      letter-spacing: .14em;
      color: var(--muted);
    }
    .log {
      max-height: 170px;
      overflow-y: auto;
      padding-right: 4px;
      font-size: .78rem;
    }
    .log-line {
      margin-bottom: 3px;
      color: var(--muted);
      display: flex;
      gap: 6px;
      align-items: baseline;
    }
    .log-tag {
      font-size: .65rem;
      text-transform: uppercase;
      letter-spacing: .16em;
      color: rgba(148,163,184,0.9);
    }

    /* Lobby overlay */
    .lobby-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    .lobby-panel {
      width: 100%;
      max-width: 520px;
      background: radial-gradient(circle at top, #020617, #000);
      border-radius: 20px;
      padding: 18px;
      border: 1px solid var(--border);
      box-shadow: 0 22px 70px rgba(15,23,42,0.95);
    }
    .lobby-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .lobby-header h2 {
      font-size: .9rem;
      text-transform: uppercase;
      letter-spacing: .18em;
    }
    .lobby-tabs {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid var(--border);
      overflow: hidden;
      font-size: .75rem;
    }
    .lobby-tab {
      padding: 5px 10px;
      border: none;
      background: transparent;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .16em;
      cursor: pointer;
      border-right: 1px solid rgba(148,163,184,0.4);
    }
    .lobby-tab:last-child {
      border-right: none;
    }
    .lobby-tab.active {
      background: rgba(34,197,94,0.16);
      color: #bbf7d0;
    }
    .lobby-grid {
      display: grid;
      grid-template-columns: repeat(2,minmax(0,1fr));
      gap: 8px;
      margin-bottom: 10px;
      font-size: .8rem;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .field label {
      font-size: .72rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .14em;
    }
    .field input[type="text"],
    .field input[type="number"] {
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.96);
      color: var(--text);
      font-size: .8rem;
    }
    .lobby-footer {
      margin-top: 8px;
      font-size: .75rem;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }
    .code-pill {
      font-variant-numeric: tabular-nums;
      letter-spacing: .18em;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
    }

    .myplayer-select {
      margin-top: 2px;
      font-size: .75rem;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title-wrap">
        <div class="title-row">
          <div class="status-dot"></div>
          <div>
            <div class="title">Impostor Arcane <span class="badge">Mesa online</span></div>
            <div id="headerSubtitle">Cre√° una sala o unite con c√≥digo para empezar.</div>
          </div>
        </div>
        <div class="myplayer-select" id="myInfo">No conectado a ninguna sala.</div>
      </div>
      <div></div>
    </header>

    <!-- LOBBY -->
    <div class="lobby-overlay" id="lobbyOverlay">
      <div class="lobby-panel">
        <div class="lobby-header">
          <h2>Configurar partida</h2>
          <div class="lobby-tabs">
            <button class="lobby-tab active" id="tabCreate">Crear sala</button>
            <button class="lobby-tab" id="tabJoin">Unirse</button>
          </div>
        </div>

        <div id="panelCreate">
          <div class="lobby-grid">
            <div class="field">
              <label for="hostName">Tu nombre</label>
              <input id="hostName" type="text" placeholder="Meli" />
            </div>
            <div class="field">
              <label for="maxPlayers">Jugadores m√°x.</label>
              <input id="maxPlayers" type="number" min="3" max="15" value="10" />
            </div>
            <div class="field">
              <label for="impostors">Impostores</label>
              <input id="impostors" type="number" min="1" max="4" value="3" />
            </div>
          </div>
          <div class="controls" style="justify-content:flex-end; margin-top:4px;">
            <button id="btnCreateRoom" class="primary">Crear sala</button>
          </div>
          <div class="lobby-footer">
            <span>Compart√≠ el c√≥digo con tus amigos para que se unan desde su celu.</span>
            <span class="code-pill" id="createCodeHint">ARC-0000</span>
          </div>
        </div>

        <div id="panelJoin" style="display:none;">
          <div class="lobby-grid">
            <div class="field">
              <label for="joinName">Tu nombre</label>
              <input id="joinName" type="text" placeholder="Juan" />
            </div>
            <div class="field">
              <label for="joinCode">C√≥digo de sala</label>
              <input id="joinCode" type="text" placeholder="ARC-XXXX" />
            </div>
          </div>
          <div class="controls" style="justify-content:flex-end; margin-top:4px;">
            <button id="btnJoinRoom" class="primary">Unirse</button>
          </div>
          <div class="lobby-footer">
            <span>Entr√° con el c√≥digo que te pase el anfitri√≥n.</span>
            <span class="code-pill" id="joinCodeHint">---</span>
          </div>
        </div>
      </div>
    </div>

    <main id="mainContent" class="blurred">
      <section class="card">
        <div class="card-inner">
          <div class="mesa-wrapper">
            <img src="mesa-impostor.png" alt="Mesa impostor" class="mesa-img" />
            <div class="mesa-label">
              <div class="mesa-label-dot"></div>
              <span id="mesaLabelText">Esperando sala...</span>
            </div>
            <div class="card-center">
              CARTA
              <div class="word" id="wordDisplay">----</div>
              <small id="roleDisplay">Cre√° sala o unite para ver tu carta.</small>
            </div>
          </div>
          <div class="hud">
            <div class="pill">
              <span class="pill-label">Turno</span>
              <span class="pill-value" id="turnTimer">00:15</span>
            </div>
            <div class="pill">
              <span class="pill-label">Votaci√≥n</span>
              <span class="pill-value" id="voteTimer">03:00</span>
            </div>
            <div class="phase-pill" id="phasePill">Fase: Lobby</div>
            <div class="chip" id="configChip">Sin sala configurada.</div>
          </div>
          <div class="controls">
            <button id="btnStartRound" class="primary" disabled>‚ñ∂ Iniciar ronda</button>
            <button id="btnSkipVote" class="skip" disabled>‚è≠ Nadie / Saltar voto</button>
          </div>

          <div class="voice-panel">
            <div class="voice-row">
              <div class="voice-status">
                <span id="voiceStatusText">Canal de voz: Discord</span>
              </div>
              <button id="btnDiscordVoice" class="secondary" disabled>üîä Abrir canal de Discord</button>
            </div>
            <div class="voice-tip" id="discordVoiceTip">
              Cuando comience la ronda, se abrir√° autom√°ticamente el canal de voz en Discord.
              Tambi√©n pod√©s usar el bot√≥n para entrar de nuevo si lo cerraste.
            </div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-inner">
          <div class="sidebar-section">
            <h3>Mesa y jugadores</h3>
            <div class="players-list" id="playersList"></div>
          </div>
          <div class="sidebar-section">
            <h3>Registro</h3>
            <div class="log" id="log"></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
  // Conexi√≥n con Socket.IO
  const socket = io();

  // Estado local del cliente
  let myId = null;
  let myName = '';
  let roomCode = null;
  let isHost = false;
  let hostId = null;
  let players = [];
  let phase = 'lobby';
  let turnIndex = 0;
  let localHasVoted = false;

  // Referencias a elementos de la UI
  const headerSubtitle = document.getElementById('headerSubtitle');
  const myInfo = document.getElementById('myInfo');
  const mainContent = document.getElementById('mainContent');
  const lobbyOverlay = document.getElementById('lobbyOverlay');

  const tabCreate = document.getElementById('tabCreate');
  const tabJoin = document.getElementById('tabJoin');
  const panelCreate = document.getElementById('panelCreate');
  const panelJoin = document.getElementById('panelJoin');
  const hostNameInput = document.getElementById('hostName');
  const maxPlayersInput = document.getElementById('maxPlayers');
  const impostorsInput = document.getElementById('impostors');
  const btnCreateRoom = document.getElementById('btnCreateRoom');
  const createCodeHint = document.getElementById('createCodeHint');
  const joinNameInput = document.getElementById('joinName');
  const joinCodeInput = document.getElementById('joinCode');
  const joinCodeHint = document.getElementById('joinCodeHint');
  const btnJoinRoom = document.getElementById('btnJoinRoom');

  const mesaLabelText = document.getElementById('mesaLabelText');
  const wordDisplay = document.getElementById('wordDisplay');
  const roleDisplay = document.getElementById('roleDisplay');
  const turnTimerEl = document.getElementById('turnTimer');
  const voteTimerEl = document.getElementById('voteTimer');
  const phasePill = document.getElementById('phasePill');
  const configChip = document.getElementById('configChip');
  const playersListEl = document.getElementById('playersList');
  const logEl = document.getElementById('log');
  const btnStartRound = document.getElementById('btnStartRound');
  const btnSkipVote = document.getElementById('btnSkipVote');

  const connectionLabelEl = document.getElementById('connectionLabel');

  // ---- Utilidades de UI ----
  function log(tag, text) {
    if (!logEl) return;
    const line = document.createElement('div');
    line.className = 'log-line';
    const t1 = document.createElement('span');
    t1.className = 'log-tag';
    t1.textContent = tag;
    const t2 = document.createElement('span');
    t2.textContent = text;
    line.appendChild(t1);
    line.appendChild(t2);
    logEl.appendChild(line);
    logEl.scrollTop = logEl.scrollHeight;
  }

  function formatSeconds(sec) {
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
  }

  function setTabs(createActive) {
    if (!tabCreate || !tabJoin || !panelCreate || !panelJoin) return;
    if (createActive) {
      tabCreate.classList.add('active');
      tabJoin.classList.remove('active');
      panelCreate.style.display = 'block';
      panelJoin.style.display = 'none';
    } else {
      tabCreate.classList.remove('active');
      tabJoin.classList.add('active');
      panelCreate.style.display = 'none';
      panelJoin.style.display = 'block';
    }
  }

  function updatePhaseUI() {
    if (!phasePill) return;
    if (phase === 'lobby') {
      phasePill.classList.remove('vote');
      phasePill.textContent = 'Fase: Lobby';
    } else if (phase === 'palabras') {
      phasePill.classList.remove('vote');
      phasePill.textContent = 'Fase: Palabras';
    } else if (phase === 'votacion') {
      phasePill.classList.add('vote');
      phasePill.textContent = 'Fase: Votaci√≥n';
    }
  }

  function updateConfigChip(extra) {
    if (!configChip) return;
    const cant = players.length;
    const base = `${cant} jugador${cant === 1 ? '' : 'es'}`;
    configChip.textContent = extra ? `${base} ¬∑ ${extra}` : base;
  }

  function updateMyCard() {
    if (!wordDisplay || !roleDisplay) return;
    if (!roomCode) {
      wordDisplay.textContent = '----';
      roleDisplay.textContent = 'Cre√° sala o unite para ver tu carta.';
      return;
    }
    // El texto concreto se actualiza en socket.on('yourRole')
  }

  function renderPlayers() {
    if (!playersListEl) return;
    playersListEl.innerHTML = '';
    players.forEach((p, idx) => {
      const row = document.createElement('div');
      row.className = 'player-item';
      if (p.id === myId) row.classList.add('me');

      const left = document.createElement('div');
      left.style.display = 'flex';
      left.style.flexDirection = 'column';

      const nameSpan = document.createElement('span');
      nameSpan.className = 'name';
      nameSpan.textContent = p.name;

      const subSpan = document.createElement('span');
      subSpan.className = 'sub';
      if (idx === turnIndex && phase === 'palabras') {
        subSpan.textContent = 'Hablando';
      } else if (phase === 'votacion') {
        subSpan.textContent = 'Votaci√≥n';
      } else {
        subSpan.textContent = 'En espera';
      }

      left.appendChild(nameSpan);
      left.appendChild(subSpan);

      const right = document.createElement('div');
      if (phase === 'votacion' && p.id !== myId) {
        const voteBtn = document.createElement('button');
        voteBtn.textContent = 'Votar';
        voteBtn.addEventListener('click', () => {
          submitVote(p.id);
        });
        right.appendChild(voteBtn);
      }

      row.appendChild(left);
      row.appendChild(right);
      playersListEl.appendChild(row);
    });
  }

  function submitVote(targetId) {
    if (!socket || localHasVoted) return;
    socket.emit('submitVote', { targetId }, (res) => {
      if (!res || !res.ok) {
        console.warn('No se pudo registrar el voto:', res && res.error);
      } else {
        localHasVoted = true;
        log('VOTO', targetId ? 'Voto registrado.' : 'Voto: Nadie.');
      }
    });
  }

  // ---- Handlers de UI ----
  if (tabCreate && tabJoin) {
    tabCreate.addEventListener('click', () => setTabs(true));
    tabJoin.addEventListener('click', () => setTabs(false));
  }

  if (btnCreateRoom) {
    btnCreateRoom.addEventListener('click', () => {
      const name = (hostNameInput.value || '').trim() || 'Jugador';
      const maxPlayers = parseInt(maxPlayersInput.value || '10', 10);
      const impostors = parseInt(impostorsInput.value || '3', 10);
      socket.emit('createRoom', { name, maxPlayers, impostors }, (res) => {
        if (!res || !res.ok) {
          alert(res && res.error ? res.error : 'Error al crear la sala');
          return;
        }
        roomCode = res.code || res.roomCode;
        myId = res.me && res.me.id;
        myName = res.me && res.me.name;
        isHost = !!res.isHost;
        if (headerSubtitle) headerSubtitle.textContent = 'Sala ' + roomCode + ' creada. Esperando jugadores‚Ä¶';
        if (myInfo) myInfo.textContent = `Vos sos ${myName} ¬∑ Anfitri√≥n de la sala ${roomCode}`;
        if (createCodeHint) createCodeHint.textContent = roomCode;
        if (joinCodeHint) joinCodeHint.textContent = roomCode;
        if (lobbyOverlay) lobbyOverlay.style.display = 'none';
        if (mainContent) mainContent.classList.remove('blurred');
        phase = 'lobby';
        updatePhaseUI();
        updateMyCard();
        log('SISTEMA', `Sala ${roomCode} creada. Esperando al menos 3 jugadores para empezar.`);
      });
    });
  }

  if (btnJoinRoom) {
    btnJoinRoom.addEventListener('click', () => {
      const name = (joinNameInput.value || '').trim() || 'Jugador';
      const codeRaw = (joinCodeInput.value || '').trim().toUpperCase();
      if (!codeRaw) {
        alert('Pon√© el c√≥digo de sala.');
        return;
      }
      socket.emit('joinRoom', { name, roomCode: codeRaw }, (res) => {
        if (!res || !res.ok) {
          alert(res && res.error ? res.error : 'Error al unirse a la sala');
          return;
        }
        roomCode = res.code || res.roomCode || codeRaw;
        myId = res.me && res.me.id;
        myName = res.me && res.me.name;
        isHost = !!res.isHost;
        if (headerSubtitle) headerSubtitle.textContent = 'Sala ' + roomCode;
        if (myInfo) myInfo.textContent = `Vos sos ${myName} ¬∑ Jugador en la sala ${roomCode}`;
        if (lobbyOverlay) lobbyOverlay.style.display = 'none';
        if (mainContent) mainContent.classList.remove('blurred');
        phase = 'lobby';
        updatePhaseUI();
        updateMyCard();
        log('SISTEMA', `Te uniste a la sala ${roomCode}.`);
      });
    });
  }

  if (btnStartRound) {
    btnStartRound.addEventListener('click', () => {
      if (!isHost) return;
      socket.emit('startRound', (res) => {
        if (!res || !res.ok) {
          alert(res && res.error ? res.error : 'No se pudo iniciar la ronda');
        }
      });
    });
  }

  if (btnSkipVote) {
    btnSkipVote.addEventListener('click', () => {
      submitVote(null);
    });
  }

  // ---- Eventos Socket.IO ----
  socket.on('roomState', (state) => {
    if (!state) return;
    roomCode = state.code || state.roomCode || roomCode;
    players = state.players || players;
    hostId = state.hostId || hostId;
    phase = state.phase || phase;
    turnIndex = typeof state.turnIndex === 'number' ? state.turnIndex : turnIndex;
    isHost = !!(myId && hostId === myId);

    updatePhaseUI();
    updateConfigChip();
    renderPlayers();

    if (connectionLabelEl && roomCode) {
      connectionLabelEl.textContent = `Servidor: conectado ¬∑ Sala ${roomCode}`;
    }
  });

  socket.on('yourRole', (data) => {
    if (!data) return;
    const role = data.role;
    const word = data.word || null;
    if (wordDisplay) {
      wordDisplay.textContent = word || '???';
    }
    if (roleDisplay) {
      if (role === 'impostor') {
        roleDisplay.textContent = 'IMPOSTOR';
        log('ROL', 'Sos IMPOS
TOR. Fing√≠ que conoc√©s la palabra.');
      } else {
        roleDisplay.textContent = 'CIUDADANO';
        log('ROL', 'Sos CIUDADANO. Conoc√©s la palabra.');
      }
    }
    updateMyCard();
  });

  socket.on('roundStarted', (data) => {
    phase = 'palabras';
    localHasVoted = false;
    updatePhaseUI();
    if (turnTimerEl) turnTimerEl.textContent = formatSeconds(30);
    if (voteTimerEl) voteTimerEl.textContent = formatSeconds(180);
    log('RONDA', 'Comienza una nueva ronda.');
    renderPlayers();
  });

  socket.on('turnChanged', (data) => {
    if (!data) return;
    turnIndex = data.turnIndex || 0;
    renderPlayers();
  });

  socket.on('playerSpoken', (data) => {
    if (!data) return;
    log('RONDA', 'Un jugador termin√≥ su turno.');
  });

  socket.on('votingStarted', () => {
    phase = 'votacion';
    localHasVoted = false;
    updatePhaseUI();
    if (voteTimerEl) voteTimerEl.textContent = formatSeconds(180);
    log('VOTO', 'Empieza la fase de votaci√≥n.');
    renderPlayers();
  });

  socket.on('voteRegistered', (data) => {
    // ya se refleja por localHasVoted, no hace falta mucho m√°s
  });

  socket.on('votingResults', (data) => {
    phase = 'lobby';
    localHasVoted = false;
    updatePhaseUI();
    if (data && data.kickedPlayer) {
      log('VOTO', `${data.kickedPlayer.name} fue expulsado. ` +
        (data.isImpostor ? '¬°Era impostor!' : 'Era ciudadano.'));
    } else {
      log('VOTO', 'Nadie fue expulsado.');
    }
    renderPlayers();
  });

  socket.on('connect', () => {
    log('SISTEMA', 'Conectado al servidor.');
  });
  socket.on('disconnect', () => {
    log('SISTEMA', 'Desconectado del servidor.');
    if (connectionLabelEl) connectionLabelEl.textContent = 'Servidor: desconectado';
  });

  // Estado inicial de pesta√±as
  setTabs(true);
  updatePhaseUI();
  updateMyCard();
</script>

</body>
</html>
